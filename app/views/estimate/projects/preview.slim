form data-bind="validate: { success: save }"
  .actions
    = render :partial => "home/buttons", :locals => { :editable => true }

  span#page-title
    /! ko if: readonly
    = t('views.estimates.projects.page.title.show')
    /! /ko
    /! ko ifnot: readonly
    /! ko if: id_presence
    = t('views.estimates.projects.page.title.edit')
    /! /ko
    /! ko ifnot: id_presence
    = t('views.estimates.projects.page.title.new')
    /! /ko
    /! /ko

  = render 'home/errors'

  fieldset
    legend = t('views.estimates.projects.customer')
    div#projects_tabs[data-bind="value: object.project.customer_type, \
                                 jqTabs: { \
                                   current: object.project.customer_type() == '#{LegalEntity.name}' ? 0 : 1, \
                                   tabSelect: changeTab, \
                                   disable: readonly, \
                                   scrollable: false }"]
      div
        ul#head
          li
            a href='##{LegalEntity.name}' tab-id='#{LegalEntity.name}'
              = t('activerecord.models.legal_entity')
          li
            a href='##{Entity.name}' tab-id='#{Entity.name}'
              = t('activerecord.models.entity')
        div
          div.tab.margtop.padleft data-tab-id='#{LegalEntity.name}'
            div.in-tabs.choice
              label for="legal_entity"
                = t('views.legal_entities.name')
                | :
              input#legal_entity[type="text" rule="required"
                                 name="#{t('views.legal_entities.name')}"
                                 data-bind="value: object.project.legal_entity.tag, \
                                            event: { keypress: clearCustomerId }, \
                                            disable: readonly"]
              input#for_legal_entity.choice-button[type="button"
                                                   data-bind="dialog: { autoOpen: false, \
                                                                        modal: true, \
                                                                        minWidth: 480, \
                                                                        minHeight: 300, \
                                                                        bind: { id: object.project.customer_id, \
                                                                               tag: object.project.legal_entity.tag, \
                                                                               identifier_value: object.project.legal_entity.identifier_value} \
                                                                      }, \
                                                              dialogId: 'legal_entities_selector', \
                                                              value: '#{t('views.estimates.catalogs.select')}', \
                                                              disable: readonly"]
            div.in-tabs
              label for="ident_value"
                = t('views.legal_entities.identifier.vatin')
                | :
              input#ident_value[type="text" data-field="identifier_value" rule="required"
                                name="#{t('views.legal_entities.identifier.vatin')}"
                                data-bind="value: object.project.legal_entity.identifier_value, \
                                           event: { keypress: clearCustomerId }, \
                                           disable: readonly"]
          div.tab.margtop.padleft data-tab-id='#{Entity.name}'
            div.in-tabs.choice
              label for="entity"
                = t('views.entities.tag')
                | :
              input#entity[type="text" rule="required" name="#{t('views.entities.tag')}"
                           data-bind="value: object.project.entity.tag, \
                                      event: { keypress: clearCustomerId }, \
                                      disable: readonly"]
              input#for_entity.choice-button[type="button"
                                             data-bind="dialog: { autoOpen: false, \
                                                                  modal: true, \
                                                                  minWidth: 480, \
                                                                  minHeight: 300, \
                                                                  bind: { id: object.project.customer_id, \
                                                                          tag: object.project.entity.tag } \
                                                                  }, \
                                                        dialogId: 'entities_selector', \
                                                        value: '#{t('views.estimates.catalogs.select')}', \
                                                        disable: readonly"]
    .margtop.choice
      label for="place"
        = t('activerecord.models.place')
        | :
      input#place[type="text" rule="required" name="#{t('activerecord.models.place')}"
                  data-bind="value: object.project.place.tag, \
                             event: { keypress: clearPlaceId }, \
                             disable: readonly"]
      input#for_place.choice-button[type="button"
                                    data-bind="dialog: { autoOpen: false, \
                                                         modal: true, \
                                                         minWidth: 480, \
                                                         minHeight: 300, \
                                                         bind: { id: object.project.place_id, \
                                                                 tag: object.project.place.tag } \
                                                        }, \
                                               dialogId: 'places_selector', \
                                               value: '#{t('views.estimates.catalogs.select')}', \
                                               disable: readonly"]
  fieldset
    legend
      = t('views.estimates.projects.find_by_catalogs')
    div
      label for="boms_catalog"
        = t('views.estimates.projects.boms_catalog')
        | :
      input#boms_catalog[type="text" rule="required"
                         name="#{t('views.estimates.projects.boms_catalog')}"
                         data-bind="dialog: { autoOpen: false, \
                                               modal: true, \
                                               minWidth: 480, \
                                               minHeight: 300, \
                                               bind: { id: object.project.boms_catalog.id, \
                                                       tag: object.project.boms_catalog.tag \
                                                     } \
                                             }, \
                                    dialogId: 'catalogs_selector', \
                                    value: object.project.boms_catalog.tag, \
                                    disable: readonly"]
    div
      label for="prices_catalog"
        = t('views.estimates.projects.prices_catalog')
        | :
      input#prices_catalog[type="text" rule="required"
                           name="#{t('views.estimates.projects.prices_catalog')}"
                           data-bind="dialog: { autoOpen: false, \
                                                 modal: true, \
                                                 minWidth: 480, \
                                                 minHeight: 300, \
                                                 bind: { id: object.project.prices_catalog.id, \
                                                         tag: object.project.prices_catalog.tag \
                                                       } \
                                               }, \
                                      dialogId: 'catalogs_selector', \
                                      value: object.project.prices_catalog.tag, \
                                      disable: readonly"]
  /! ko if: readonly
  fieldset data-bind="with: object.locals"
    div
      legend
        = t('views.estimates.projects.locals.name')
      input[type="button" data-bind="click: $parent.addLocal, disable: !$parent.readonly()"
            value="#{t('views.estimates.projects.locals.add')}"]
      = render partial: 'estimate/locals/table'
      input[type="button" data-bind="click: $parent.addLocal, disable: !$parent.readonly()"
            value="#{t('views.estimates.projects.locals.add')}"]
  /! /ko

= render :partial => "home/select_dialog", :locals => { :dialog_id => 'places_selector',
                                                        :dialog_model => 'dialog_places',
                                                        :data_path => 'items' }
= render :partial => "home/select_dialog", :locals => { :dialog_id => 'entities_selector',
                                                        :dialog_model => 'dialog_entities',
                                                        :data_path => 'items' }
= render :partial => "home/select_dialog", :locals => { :dialog_id => 'legal_entities_selector',
                                                        :dialog_model => 'dialog_legal_entities',
                                                        :data_path => 'items' }
= render partial: "home/select_dialog",
         locals: { dialog_id: 'catalogs_selector',
                   dialog_model: 'dialog_catalogs',
                   data_path: 'estimate/catalogs/catalogs' }
