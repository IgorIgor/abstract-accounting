<form data-bind="validate: { success: save }">
  <div class='actions'>
    <%= render :partial => "home/buttons", :locals => { :editable => true } %>
  </div>

  <span id="page-title">
    <!-- ko if: readonly -->
    <%= t('views.estimates.bo_m.page.title.show') %>
    <!-- /ko -->
    <!-- ko ifnot: readonly -->
      <!-- ko if: id_presence -->
      <%= t('views.estimates.bo_m.page.title.edit') %>
      <!-- /ko -->
      <!-- ko ifnot: id_presence -->
      <%= t('views.estimates.bo_m.page.title.new') %>
      <!-- /ko -->
    <!-- /ko -->
  </span>

  <%= render 'home/errors' %>

  <fieldset>
    <div>
      <div>
        <span class="form-cell-label">
          <label for="uid"><%= t('views.estimates.uid') %>:</label>
        </span>
        <span>
          <input id="uid" type="text" name="<%= t('views.estimates.uid') %>"  rule="required"
                 data-bind="value: object.bo_m.uid,
                            disable: readonly"/>
        </span>
      </div>
      <div>
        <span class="form-cell-label">
          <label for="asset_tag"><%= t('views.resources.tag') %>:</label>
        </span>
        <span>
          <input type="text" id="asset_tag"
                 name="<%= t('views.resources.tag') %>" rule="required"
                 data-bind="autocomplete: { source: 'assets.json',
                                             value: 'tag',
                                             onlySelect: false,
                                             bind: {
                                               id: object.bo_m.resource_id,
                                               mu: object.resource.mu
                                             }
                                           },
                                           value: object.resource.tag,
                                           disable: readonly">
        </span>
      </div>
      <div>
        <span class="form-cell-label">
          <label for="asset_mu"><%= t('views.resources.mu') %>:</label>
        </span>
        <span>
          <input type="text" id="asset_mu" rule="required"
                 name="<%= t('views.resources.mu') %>"
                 data-bind="value: object.resource.mu, valueUpdate: 'afterkeydown',
                            disable: readonly, event: {keypress: resourceClear}">
        </span>
      </div>
      <div>
        <span class="form-cell-label">
          <label for="bom_catalog"><%= t('views.estimates.catalog') %>:</label>
        </span>
        <span>
          <input type="text" id="bom_catalog" rule="required"
                 name="<%= t('views.estimates.catalog') %>"
                 data-bind="dialog: { autoOpen: false,
                                       modal: true,
                                       minWidth: 480,
                                       minHeight: 300,
                                       bind: { id: object.bo_m.catalog_id,
                                               tag: object.catalog.tag }
                                     },
                            dialogId: 'catalogs_selector',
                            value: object.catalog.tag,
                            disable: readonly">
        </span>
      </div>
    </div>

    <table class="elements-align-center">
      <thead>
        <tr>
          <th class="col-width"><%= t('views.estimates.code') %></th>
          <th><%= t('views.resources.tag') %></th>
          <th class="col-width"><%= t('views.resources.mu') %></th>
          <th class="col-width"><%= t('views.estimates.rate') %></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr class="font-bold">
          <td>1</td>
          <td><%= t('views.estimates.elements.builders') %></td>
          <td><%= t('views.estimates.elements.mu.people') %></td>
          <td><input type="text" id="builders" name="<%= t('views.estimates.elements.builders') %>"
                     rule="dependency_required number" dependency_required="rank"
                     data-bind="value: object.bo_m.workers_amount, disable: readonly">
          </td>
          <td></td>
        </tr>
        <tr>
          <td>1.1</td>
          <td><%= t('views.estimates.elements.rank') %></td>
          <td></td>
          <td><input type="text" id="rank" name="<%= t('views.estimates.elements.rank') %>"
                     rule="dependency_required number" dependency_required="builders"
                     data-bind="value: object.bo_m.avg_work_level, disable: readonly">
          </td>
          <td></td>
        </tr>
        <tr class="font-bold">
          <td>2</td>
          <td><%= t('views.estimates.elements.machinist') %></td>
          <td><%= t('views.estimates.elements.mu.people') %></td>
          <td><input type="text" name="<%= t('views.estimates.elements.machinist') %> "
                     rule="number" id="machinist"
                     data-bind="value: object.bo_m.drivers_amount, disable: readonly">
          </td>
          <td></td>
        </tr>
        <tr class="font-bold">
          <td>3</td>
          <td><%= t('views.estimates.elements.machinery') %></td>
          <td></td>
          <td></td>
          <td class="table-actions">
            <span class="mini-icon add" id="add-mach" data-bind="visible: !readonly(),
                                      click: addMachinery">
            </span>
          </td>
        </tr>
        <!-- ko foreach: object.machinery -->
        <tr>
          <td>
            <input type="text" rule="required"
                   data-bind="attr: { name: '<%= t('views.estimates.elements.machinery') %>#'
                                            + $parent.indexOfMachinery($data) +
                                            ' <%= t('views.estimates.code') %>',
                                      id: 'machinery_uid_' + $parent.indexOfMachinery($data)},
                              value: uid, disable: $parent.readonly">
          </td>
          <td>
            <input type="text" rule="required"
                   data-bind="attr: { name: '<%= t('views.estimates.elements.machinery') %>#'
                                            + $parent.indexOfMachinery($data) +
                                            ' <%= t('views.estimates.name') %>',
                                      id: 'machinery_tag_' + $parent.indexOfMachinery($data)},
                              autocomplete: { source: 'assets.json?mu=' +
                                            '<%= t('views.estimates.elements.mu.machine') %>',
                                              value: 'tag', onlySelect: false,
                                              bind: { id: resource_id } },
                              value: resource.tag, disable: $parent.readonly">
          </td>
          <td><%= t('views.estimates.elements.mu.machine') %></td>
          <td>
            <input type="text" rule="required number"
                   data-bind="attr: { name: '<%= t('views.estimates.elements.machinery') %>#'
                                            + $parent.indexOfMachinery($data) +
                                            ' <%= t('views.estimates.rate') %>',
                                      id: 'machinery_rate_' + $parent.indexOfMachinery($data)},
                              value: amount, disable: $parent.readonly" >
          </td>
          <td class="table-actions">
            <span class="mini-icon delete" id="remove-mach"
                  data-bind="visible: !$parent.readonly(),
                             click: function(){ $parent.removeMachinery($data);}">
            </span>
          </td>
        </tr>
        <!-- /ko -->
        <tr class="font-bold">
          <td>4</td>
          <td><%= t('views.estimates.elements.resources') %></td>
          <td></td>
          <td></td>
          <td class="table-actions">
            <span class="mini-icon add" id="add-res" data-bind="visible: !readonly(),
                                      click: addMaterials">
            </span>
          </td>
        </tr>
        <!-- ko foreach: object.materials -->
        <tr>
          <td><input type="text" rule="required"
                     data-bind="attr: { name: '<%= t('views.estimates.elements.resources') %>#' +
                                          $parent.indexOfMaterials($data) +
                                          ' <%= t('views.estimates.code') %>',
                                        id: 'resources_uid_' + $parent.indexOfMaterials($data)
                                       }, value: uid, disable: $parent.readonly">
          </td>
          <td><input type="text" rule="required"
                     data-bind="autocomplete: { source: 'assets.json',
                                                value: 'tag',
                                                onlySelect: false,
                                                bind: {
                                                 id: resource_id,
                                                 mu: resource.mu
                                                }
                                              },
                                 attr: { name: '<%= t('views.estimates.elements.resources') %>#' +
                                          $parent.indexOfMaterials($data) +
                                          ' <%= t('views.estimates.name') %>',
                                        id: 'resources_tag_' + $parent.indexOfMaterials($data)
                                        }, value: resource.tag, disable: $parent.readonly">
          </td>
          <td><input type="text" rule="required"
                     data-bind="attr: { name: '<%= t('views.estimates.elements.resources') %>#' +
                                          $parent.indexOfMaterials($data) +
                                          ' <%= t('views.resources.mu') %>',
                                        id: 'resources_mu_' +
                                            $parent.indexOfMaterials($data)
                                       },
                                       value: resource.mu, disable: $parent.readonly,
                                       event: {keypress: $parent.elementResourceClear}">
          </td>
          <td><input type="text" rule="required number"
                     data-bind="attr: { name: '<%= t('views.estimates.elements.resources') %>#' +
                                          $parent.indexOfMaterials($data) +
                                          ' <%= t('views.estimates.rate') %>',
                                        id: 'resources_rate_' +
                                            $parent.indexOfMaterials($data)
                                       },
                                       value: amount, disable: $parent.readonly">
          </td>
          <td class="table-actions">
            <span class="mini-icon delete" id="remove-res"
                  data-bind="visible: !$parent.readonly(),
                             click: function(){ $parent.removeMaterials($data); }">
            </span>
          </td>
        </tr>
        <!-- /ko -->
      </tbody>
    </table>
  </fieldset>
</form>

<%= render :partial => "home/select_dialog",
           :locals => { :dialog_id => 'catalogs_selector',
                        :dialog_model => 'dialog_catalogs',
                        :data_path => 'estimate/catalogs/catalogs' } %>
